'use strict';
const common = require('../common');
const assert = require('assert');
const path = require('path');
const fs = require('fs');

if (process.platform === 'darwin') {
  var watchSeenOne = 0;

  const testDir = common.tmpDir;

  const filenameOne = 'watch.txt';
  const testsubdirName = 'testsubdir';
  const testsubdir = path.join(testDir, testsubdirName);
  const relativePathOne = path.join('testsubdir', filenameOne);
  const filepathOne = path.join(testsubdir, filenameOne);

  common.refreshTmpDir();

  process.on('exit', function() {
    assert.ok(watchSeenOne > 0);
  });

  function cleanup() {
    try { fs.unlinkSync(filepathOne); } catch (e) { }
    try { fs.rmdirSync(testsubdir); } catch (e) { }
  };

  try { fs.mkdirSync(testsubdir, 0o700); } catch (e) {}

  assert.doesNotThrow(function() {
    const watcher = fs.watch(testDir, {recursive: true});
    watcher.on('change', function(event, filename) {
      assert.ok('change' === event || 'rename' === event);

      // Ignore stale events generated by mkdir and other tests
      if (filename !== relativePathOne)
        return;

      watcher.close();
      cleanup();
      ++watchSeenOne;
    });
  });

  setTimeout(function() {
    fs.writeFileSync(filepathOne, 'world');
  }, 10);
}
